# Copyright (C) 2025-2026 Peter Robinson
# SPDX-License-Identifier: GPL-2.0+

#!/bin/sh
set -x

# Check for existance of a UDC interface
if ! [ -e /sys/class/udc/* ]; then
	exit 0
fi

# Needs to be run as root
if [ "$(whoami)" != "root" ]; then
        echo "Error: This needs to be run as root"
        exit 1
fi

# Load config file, first from /etc, else the local dir
sysconfdir="/etc"
if [ -f ${sysconfdir}/usb-gadget.conf ]; then
        . ${sysconfdir}/usb-gadget.conf
elif [ -f ./usb-gadget.conf ]; then
	. ./usb-gadget.conf
else
	echo "Error: No config found"
	exit 1
fi

# Use the Distribution name if we can determine it
if [ -f ${sysconfdir}/os-release ]; then
	USB_MAN=`grep '^NAME' /etc/os-release | awk -F= '{print $2}'`
	echo "$USB_MAN"
fi

# Need to make all the features configurable - Network, console maybe storage

# Get the UDC address
UDCDEV=`ls /sys/class/udc`

# Initial USB device configuration
modprobe libcomposite
mkdir -p /sys/kernel/config/usb_gadget/g0
cd /sys/kernel/config/usb_gadget/g0

echo $USB_VENDOR > idVendor
echo $USB_PROD > idProduct

mkdir strings/0x409
echo $USB_MAN > strings/0x409/manufacturer
echo $USB_PROD > strings/0x409/product

mkdir configs/c.1
if [ "$UDC_NET" = true ]; then
	mkdir -p functions/ecm.usb0
	ln -s functions/ecm.usb0/ configs/c.1/
fi
if [ "$UDC_CON" = true ]; then
	mkdir -p functions/acm.usb0
	ln -s functions/acm.usb0/ configs/c.1/
fi

echo $UDCDEV > UDC
cd -
# End device configuration
